# Claude 項目開發系統

## 概述

這是一個通用配置，可以自動支持 `dev/active/` 目錄中的所有項目。

---

##  上下文管理系統

### 上下文生命週期

```
新會話開始
    ↓
上下文容量：100%

工作過程中：
├─ 30% →  正常工作繼續
├─ 50% →  正常工作繼續
├─ 70% →  Claude 主動提醒：「上下文已用 70%，建議保存進度」
├─ 85% →  Claude 警告：「上下文已用 85%，執行 /update-dev-docs」
└─ 95%+ → 無法執行新操作

保存進度：
    ↓
執行 /update-dev-docs
    ↓
新會話（continue）：
    ↓
上下文容量：100%（已恢復）
```

### Claude 的主動上下文監控

**Claude 必須在以下閾值監控並主動提醒：**

####  70% 上下文使用 - 準備階段

當 Claude 偵測到上下文達到 ~70% 時：

```
Claude 說：
" 上下文警告（已用 70%）：
 • 當前會話上下文使用率：70%
 • 建議：開始準備保存進度
 • 無須立即行動 - 繼續工作
 • 當達到 85% 時我會再次提醒"
```

**Claude 應該做的：**
-  提供清晰的上下文百分比
-  確認進入準備階段
-  繼續正常工作
-  密切監控使用量增加

**用戶應該做的：**
-  注意警告
-  心理上為保存做準備
-  繼續完成當前任務

####  85% 上下文使用 - 行動必需階段

當 Claude 偵測到上下文達到 ~85% 時：

```
Claude 說：
" 上下文警告（已用 85%）：
 • 當前會話上下文使用率：85%
 • 行動必需：現在執行 /update-dev-docs
 
 可選方案：
 1️  你執行：/update-dev-docs
     ↓ 我將所有進度保存到 tasks.md
     ↓ 然後準備好「continue」命令
     
 2️  我可以詢問用戶是否準備好：「執行 /update-dev-docs？」
     ↓ 你的確認：「yes」或「y」
     ↓ 我將進行保存

 現在保存的好處：
  不會丟失進度
  上下文乾淨重置
  新會話無縫續接"
```

**Claude 應該做的：**
-  停止啟動新任務
-  如果接近完成則完成當前任務
-  說出具體的百分比數字
-  提供清晰的行動項目
-  如需要則等待用戶確認

**用戶應該做的：**
-  立即執行 `/update-dev-docs`
- 或在 Claude 詢問時確認
-  等待完成
-  然後在新會話執行 `continue`

####  95%+ 上下文使用 - 緊急模式

當 Claude 偵測到上下文達到 ~95%+ 時：

```
Claude 說：
" 緊急：上下文已 95%+（幾乎滿）：
 
 立即行動：
 • 無法開始新的代碼編輯
 • 必須立即執行 /update-dev-docs
 • 保存後：用「continue」開始新會話
 
 狀態：
  至今所有工作：已保存（到三個文件）
  進度：已追蹤（在 tasks.md 中）
  新操作：已阻止（上下文不足）"
```

**Claude 應該做的：**
-  拒絕新的編輯操作
-  提供最終總結
-  強調保存的重要性
-  沒有新會話無法繼續

**用戶應該做的：**
-  立即執行 `/update-dev-docs`
-  然後執行 `continue` 開始新會話
-  不要嘗試在 95%+ 執行新操作

---

## 上下文監控實現

### Claude 如何監控上下文

Claude 應該使用這些內部檢查：

1. **消息計數估算**
   - 計算會話開始以來的對話輪次
   - 粗略估算：每 ~50 回合 ≈ 20% 上下文使用
   - 用於初步警告

2. **內容體積估算**
   - 編寫的代碼塊數量
   - 提供的解釋長度
   - 編輯的文件大小
   - 累積這些 = 上下文增長

3. **自我反思**
   - 注意到回應變短
   - 注意到文件加載變慢
   - 注意到思考受限
   - 這些都是上下文高使用率的信號

4. **基於時間線的估算**
   - 在項目上工作 30+ 分鐘 → 可能 60-70%
   - 在項目上工作 1+ 小時 → 可能 80-90%
   - 用作額外信號

### 何時警告用戶

**自動警告應該在以下時機發生：**
-  70% - 準備提醒（信息性）
-  85% - 行動必需（緊急）
-  95%+ - 緊急模式（阻止）

**檢查頻率：**
- 每 3-5 個代碼塊或主要操作後
- 或每 10 個用戶消息後
- 不要持續檢查（那樣會很煩人）

---

## 斜杠命令

### /dev-docs
**目的**：為新項目創建全面的開發文檔

**用法**：
```
/dev-docs
```

**功能**：
1. 詢問項目名稱（例如：royaltek-dashboard, web-ui-project）
2. 詢問項目描述
3. 分析當前項目結構
4. 進入規劃模式（創建文檔，不寫代碼）
5. 在 `dev/active/[project-name]/` 中生成三個文檔：
   - `[project-name]-plan.md` - 完整項目計劃
   - `[project-name]-context.md` - 背景和架構
   - `[project-name]-tasks.md` - 任務檢查清單

**輸出**：三個準備就緒的 markdown 文件

**下一步**：審查文檔，然後說「Execute plan」

---

### Execute plan
**目的**：根據項目計劃開始實現

**用法**：
```
Execute plan
```

**Claude 將做什麼**：
1. 自動偵測 `dev/active/` 中的當前項目
   - 如果有多個項目：使用最近修改的
   - 如果只有一個項目：使用該項目
   
2. 自動加載三個項目文檔：
   ```bash
   cat dev/active/[project-name]/[project-name]-plan.md
   cat dev/active/[project-name]/[project-name]-context.md
   cat dev/active/[project-name]/[project-name]-tasks.md
   ```

3. 完全理解項目結構和需求

4. 開始實現第一階段
   - 創建項目結構
   - 設置依賴項
   - 創建基礎類/組件

5. 自動使用編碼格式技能格式化代碼（RoyalTek 標準）

6. **新增：每次完成任務後通過 PostToolUse Hook 更新 `tasks.md`：**
   - 追蹤編輯的文件
   - 更新完成的子任務
   - 自動計算進度百分比
   - 記錄完成時間戳

**重要**：無需手動加載文件 - Claude 自動偵測和加載一切

---

### /update-dev-docs
**目的**：當上下文即將滿時保存所有進度

**用法**：
```
/update-dev-docs
```

**何時使用**：當上下文使用率達到 85%+ 時

**功能**：

1. **最終進度更新**
   ```
    掃描當前會話中的所有編輯文件
    用所有完成情況更新 tasks.md
    計算最終進度百分比
    添加完成時間戳
   ```

2. **狀態文檔記錄**
   ```
    記錄哪個階段/任務被中斷
    文檔記錄下次應開始的任務
    記錄任何未完成的子任務
    記錄會話期間做出的決策
   ```

3. **上下文準備**
   ```
    完成工作的摘要
    創建/修改的文件清單
    狀態報告
    準備好新會話
   ```

4. **結果**
   - 所有工作都保存在 markdown 文件中
   - tasks.md 已 100% 更新
   - 準備好在新會話執行 `continue`

**示例輸出**：
```
/update-dev-docs 摘要：
 第一階段進度：5/10 任務（50%）
 已完成：
  - 任務 1.1：設置（100%）
  - 任務 1.2：認證系統（80% - 中斷）
 下一個任務：任務 1.2 繼續（已完成 80%）
 修改的文件：
  - auth.py（新增 150 行）
  - config.py（新增 50 行）
  - tests.py（新增 80 行）
 準備好新會話
```

---

### continue
**目的**：在新會話中恢復項目工作

**用法**：
```
continue
```

**Claude 將做什麼**：

1. **自動加載項目文檔**
   ```bash
   cat dev/active/[project-name]/[project-name]-plan.md
   cat dev/active/[project-name]/[project-name]-context.md
   cat dev/active/[project-name]/[project-name]-tasks.md
   ```

2. **理解之前的進度**
   - 審查哪些任務已完成 
   - 審查哪些任務進行中 
   - 確定確切的工作中斷位置

3. **恢復完整上下文**
   ```
    項目結構：已知
    架構決策：已知
    已完成工作：已知
    下一個任務：清楚
    新上下文容量：100%
   ```

4. **恢復實現**
   - 從下一個未完成的任務開始
   - 參考上一個會話的完成代碼
   - 無縫繼續

**結果**：無縫延續，無上下文丟失，無知識丟失

---

##  PostToolUse Hook 系統（未來增強）

### 概述

PostToolUse Hook 在每個文件編輯後自動更新任務進度。

**目標**：實時進度追蹤，無需手動更新

### 工作原理

```
時間線：

用戶：Execute plan
Claude：編輯 auth.py（100 行）
    ↓
[PostToolUse Hook 觸發]
    ↓
Hook 邏輯：
1. 偵測：編輯了 auth.py（新增 100 行）
2. 匹配：任務 1.1 包括「實現 auth.py」
3. 更新：tasks.md - 標記 auth.py 
4. 計算：任務 1.1 進度（1/5 文件 = 20%）
5. 記錄：時間戳、文件信息、行數
    ↓
tasks.md 實時更新 

Claude：編輯 config.py（30 行）
    ↓
[PostToolUse Hook 觸發]
    ↓
Hook：更新 tasks.md - config.py 
任務 1.1 進度：2/5 文件 = 40% 
    ↓
... 繼續 ...

結果：
 tasks.md 始終反映當前狀態
 無需手動更新
 無縫進度追蹤
```

### Hook 在不同上下文級別的行為

**70% 上下文 - 完整更新模式**
```
PostToolUse Hook：
- 詳細文件分析
- 完整任務匹配
- 完整進度計算
- 存儲所有元數據
```

**85% 上下文 - 輕量級更新模式**
```
PostToolUse Hook（降級）：
- 僅記錄文件名
- 快速子任務檢查框更新
- 簡單進度計數（無百分比計算）
- 標記「下一個會話需要完整驗證」
```

**95%+ 上下文 - 最小化模式**
```
PostToolUse Hook（緊急）：
- 僅記錄文件名
- 最基本的檢查點
- 延遲完整更新到 Stop Hook
- 標記「下一個會話將完成」
```

---

## 自動偵測邏輯

### 當你說「Execute plan」時，Claude 將：

```
步驟 1：檢查 dev/active/ 目錄
  ✓ 如果存在：繼續
  ✗ 如果不存在：請你先運行 /dev-docs

步驟 2：列出 dev/active/ 中的所有項目
  • 一個項目：使用該項目
  • 多個項目：使用最近修改的
  • 沒有項目：請你先運行 /dev-docs

步驟 3：自動加載三個項目文檔
  cat dev/active/[project-name]/[project-name]-plan.md
  cat dev/active/[project-name]/[project-name]-context.md
  cat dev/active/[project-name]/[project-name]-tasks.md

步驟 4：完全理解項目

步驟 5：根據計劃開始實現
```

### 項目目錄結構

```
dev/active/
├── royaltek-dashboard/
│   ├── royaltek-dashboard-plan.md
│   ├── royaltek-dashboard-context.md
│   └── royaltek-dashboard-tasks.md
│
├── web-ui-project/
│   ├── web-ui-project-plan.md
│   ├── web-ui-project-context.md
│   └── web-ui-project-tasks.md
│
└── api-service/
    ├── api-service-plan.md
    ├── api-service-context.md
    └── api-service-tasks.md
```

---

## 開發工作流程

### 對於任何新項目

```
步驟 1：/dev-docs
        ↓ 提供項目信息
        ↓ 獲得三個文檔

步驟 2：審查文檔
        ↓ 檢查計劃是否良好
        ↓ 批准或請求更改

步驟 3：Execute plan
        ↓ Claude 自動加載文檔
        ↓ 開始編碼
        ↓ PostToolUse Hook 自動更新進度
        ↓ 上下文監控在 70%、85%、95%+ 時警告

步驟 4：/update-dev-docs（當上下文滿時）
        ↓ 保存最終進度
        ↓ 記錄下一個會話的狀態
        ↓ 系統準備好新會話

步驟 5：continue（在新會話）
        ↓ 自動加載文檔
        ↓ 恢復上下文
        ↓ 從上次未完成的任務繼續
```

### 在項目間切換

如果你在 `dev/active/` 中有多個項目：

```
當前工作：royaltek-dashboard
上下文使用：70%

你：「切換到 web-ui-project」
  ↓
Claude：自動偵測 dev/active/web-ui-project/
Claude：加載 web-ui-project 文檔
Claude：開始工作 web-ui-project

稍後：

你：「回到 royaltek-dashboard」
  ↓
Claude：自動偵測 dev/active/royaltek-dashboard/
Claude：加載 royaltek-dashboard 文檔
Claude：從中斷處恢復
```

---

## 開發規則

### 開始實現之前
- ✓ 加載三個項目文檔
- ✓ 理解完整的項目結構
- ✓ 審查實現計劃
- ✓ 檢查任何約束或風險

### 開發期間
- ✓ 嚴格遵循 plan.md 結構
- ✓ 參考 context.md 的架構決策
- ✓ 檢查 tasks.md 的任務詳情和依賴關係
- ✓ 自動使用編碼格式技能（RoyalTek 標準）
- ✓ 編寫乾淨、結構良好的代碼
- ✓ 監控上下文使用（在 70%、85%、95%+ 時警告）

### 完成每個任務後
- ✓ PostToolUse Hook 自動標記完成
- ✓ 進度百分比自動更新
- ✓ 實現注釋自動記錄
- ✓ 移動到下一個任務

### 當上下文已滿時（85%+）
- ✓ 執行 /update-dev-docs
- ✓ 將所有進度保存到文件
- ✓ 在新會話之前審查摘要
- ✓ 在新會話中繼續使用 `continue`

### 會話之間
- ✓ 使用「continue」命令
- ✓ Claude 自動加載所有文檔
- ✓ 從中斷處完全相同地恢復
- ✓ 沒有上下文丟失，沒有知識丟失

---

## 上下文監控檢查清單

### Claude 的責任

在 **70% 上下文使用**：
- [ ] 偵測上下文接近 70%
- [ ] 提供清晰的警告並附上百分比
- [ ] 解釋：「準備階段 - 繼續工作」
- [ ] 設定預期：「當達到 85% 時我會再次警告」

在 **85% 上下文使用**：
- [ ] 偵測上下文達到 85%
- [ ] 提供緊急警告並附上百分比
- [ ] 說明行動必需：「/update-dev-docs」
- [ ] 提供等待確認
- [ ] 準備立即保存

在 **95%+ 上下文使用**：
- [ ] 阻止新的編輯操作
- [ ] 提供最終摘要
- [ ] 強調緊迫性
- [ ] 沒有新會話無法繼續

### 用戶的責任

在 **70% 警告**：
- [ ] 注意警告
- [ ] 確認理解
- [ ] 繼續正常工作
- [ ] 做準備

在 **85% 警告**：
- [ ] 立即執行 `/update-dev-docs`
- [ ] 或在 Claude 詢問時確認
- [ ] 等待完成消息
- [ ] 然後為新會話執行 `continue`

在 **95%+ 緊急**：
- [ ] 立即執行 `/update-dev-docs`
- [ ] 不要嘗試新操作
- [ ] 預期阻止行為
- [ ] 用 `continue` 開始新會話

---

## 示例工作流程

### 示例 1：正常會話流程

```
會話 1：
├─ 你：Execute plan
├─ Claude：加載文檔，開始第一階段
├─ Claude：工作中，上下文 50%
├─ Claude：（30 分鐘後） 上下文 70%，提醒已發送
├─ Claude：繼續工作，上下文 80%
├─ Claude：（10 分鐘後） 上下文 85%，需要行動
├─ Claude：等待 /update-dev-docs 命令
│
├─ 你：/update-dev-docs
├─ Claude：保存所有進度，提供摘要
├─ Claude：準備好新會話
│
└─ 你：continue

會話 2：
├─ Claude：自動加載所有文檔
├─ Claude：審查進度（第一階段：50% 完成）
├─ Claude：從任務 1.6（未完成）繼續
├─ Claude：新上下文容量 100%
└─ ... 工作繼續 ...
```

### 示例 2：緊急高上下文

```
你：Execute plan
Claude：第一階段工作開始

（大量編輯、許多解釋）

Claude：（突然） 上下文 95%！
        無法繼續編輯
        立即執行 /update-dev-docs
        
你：/update-dev-docs
Claude： 最終保存完成
        準備好：continue

你：continue
Claude：新會話已開始，100% 上下文
        從中斷處恢復
```

---

## 主要優勢

 **一次性設置** - 創建一次 CLAUDE.md，永久使用
 **自動偵測** - 自動找到當前項目
 **多項目支持** - 同時支持無限個項目
 **無需配置** - 新項目自動工作
 **通用** - 所有項目相同的工作流程
 **無縫** - 項目和會話之間的平滑過渡
 **文檔保存** - 所有進度保存在 markdown 文件中
 **上下文感知** - 在 70%、85%、95%+ 時主動監控
 **實時追蹤** - PostToolUse Hook 自動更新進度（未來）
 **無知識丟失** - 三文件系統保存所有上下文

---

## 重要說明

### CLAUDE.md 每次都被讀取
- Claude Code 啟動時讀取此文件
- 每個用戶輸入都參考此文件
- 更改立即生效（如需要可重啟）

### 自動偵測優先級
- 默認使用最近修改的項目
- 可以顯式命名項目以切換
- 無歧義 - Claude 始終知道使用哪個項目

### 文檔持久性
- 所有三個文檔存儲在 `dev/active/[project-name]/`
- 跨會話持久
- 可隨時審查和編輯
- 可以用 git 管理版本

### 上下文監控
- Claude 的自我認知是主要機制
- 警告是信息性的，不是自動觸發
- 用戶完全控制何時保存/切換會話
- PostToolUse Hook（未來）將提供備份追蹤

### 無需手動加載
- Claude 自動加載所有文檔
- 用戶無需使用「cat」命令
- 在後台透明地發生
- 用戶無需看到文件內容（但可以看）

---

## 目錄設置

如果 `dev/` 目錄還不存在：

```bash
mkdir -p dev/active
mkdir -p dev/completed
```

這由 `/dev-docs` 命令自動完成，但你也可以手動設置。

---

## 故障排除

### 問題：「無法找到 dev/active/ 目錄」
**解決方案**：先運行 `/dev-docs` 創建項目

### 問題：多個項目 - 使用哪一個？
**解決方案**：使用最近修改的項目。顯式說出項目名稱以切換。

### 問題：舊文檔沒有更新
**解決方案**：運行 `/update-dev-docs` 確保所有更改已保存

### 問題：上下文變滿
**解決方案**：監控 70% 警告準備；在 85% 警告時立即執行 `/update-dev-docs`

### 問題：上下文滿後進度丟失
**解決方案**：在上下文達到 100% 之前執行 `/update-dev-docs` 以保留所有進度

---

## 快速參考

| 命令 | 目的 | 何時使用 |
|------|------|--------|
| `/dev-docs` | 創建新項目文檔 | 啟動新項目 |
| `Execute plan` | 開始/繼續項目實現 | 開始編碼 |
| `/update-dev-docs` | 保存進度，準備新會話 | 上下文達到 85%+ |
| `continue` | 在新會話中恢復 | 執行 /update-dev-docs 後 |
| `切換到 [項目]` | 在項目間切換 | 管理多個項目 |

---

## 摘要

這是一個**通用、項目無關的**開發系統，：

1.  為任何項目創建全面的計劃
2.  需要時自動加載項目文檔
3.  自動偵測支持多個項目
4.  在 markdown 文件中保存進度（三文件系統）
5.  啟用無縫會話恢復
6.  **主動監控上下文使用率（70%、85%、95%+）**
7.  **實時追蹤進度（PostToolUse Hook - 未來）**
8.  一次性設置，永久使用

**一個文件，無限項目，完整自動化，上下文感知。**
